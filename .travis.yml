language: go

go:
  - 1.7.x

sudo: required

# env:
#   - CNI_PATH=/opt/

services:
  - docker

before_install:
  # Get the linter.
  - go get github.com/golang/lint/golint
  # Clone CNI repo proper
  - git clone https://github.com/containernetworking/cni.git /tmp/cni
  # Clone the default plugins.
  - git clone https://github.com/containernetworking/plugins.git /tmp/plugins
  # Make a dir to store the CNI network configuration.
  - mkdir -p /tmp/netconf

script:
  # Build out ratchet proper.
  - mkdir bin
  - cd ratchet
  - golint
  - go test -v
  - go build -o ~/ratchet-cni/bin/ratchet
  - cd ../
  # Build out the child.
  - cd ratchet-child
  - golint
  - go test -v
  - go build -o ~/ratchet-cni/bin/ratchet-child
  # List the binaries
  - cd ../ && ls -lathr ./bin
  # Setup for running with CNI docker.
  - | 
    cat >/tmp/netconf/10-mynet.conf <<EOF
    {
      "name": "ratchet-demo",
      "type": "ratchet",
      "etcd_host": "localhost",
      "child_path": "/opt/cni/bin/ratchet-child",
      "delegate": {
        "name": "cbr0",
        "type": "loopback",
        "delegate": {
          "isDefaultGateway": true
        }
      },
      "boot_network": {
        "type": "loopback"
      }
    }
    EOF
  - cd /tmp/plugins
  - ./build.sh
  - cp ~/ratchet-cni/bin/* ./bin/
  - export CNI_PATH=$(pwd)/bin
  # 
    #   image: "quay.io/coreos/etcd"
    # ports: 
    #   - "4001:4001"
    #   - "2380:2380"
    #   - "2379:2379"
    # command: >
    #   etcd
    #   -name etcd0
    #   -advertise-client-urls http://172.17.0.1:2379,http://172.17.0.1:4001
    #   -listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001
    #   -initial-advertise-peer-urls http://172.17.0.1:2380
    #   -listen-peer-urls http://0.0.0.0:2380
    #   -initial-cluster-token etcd-cluster-1
    #   -initial-cluster etcd0=http://172.17.0.1:2380
    #   -initial-cluster-state new

  # Run CNI docker.
  - cd /tmp/cni/scripts
  - export NETCONFPATH=/tmp/netconf
  - CNI_PATH=$CNI_PATH ./docker-run.sh --rm busybox:latest ifconfig